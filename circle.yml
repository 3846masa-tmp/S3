# sample circle.yml for IronMan-s3
machine:
  environment:
    docker_image: ${CIRCLE_PROJECT_REPONAME,,}  # lowercase
    docker_tag: ${CIRCLE_SHA1:0:7}
  #we package the software through docker
  services:
    - docker

checkout:
  override:
    # checkout the IronMan-ci
    - git clone git@github.com:scality/IronMan-CI.git
    # place the file gathered from IronMan-CI where needed
    - mv IronMan-CI/deployment .
    - mv IronMan-CI/ci/matryoshka*  ./tests
    # Poor man docker image cache
    - if [ ! -d ~/dockerimg ]; then mkdir ~/dockerimg  ; fi
    - if [ ! -f ~/dockerimg/pcurl.sh ]; then  curl -o  ~/dockerimg/pcurl.sh  http://demo.scality.com/ironman/pcurl.sh ; chmod ugoa+x ~/dockerimg/pcurl.sh   ; fi
    - if [ ! -f ~/dockerimg/base.tar.gz ]; then cd  ~/dockerimg/ &&  ./pcurl.sh http://demo.scality.com/ironman/base.tar.gz ; cd .. ; fi

dependencies:
  cache_directories:
    - "~/dockerimg"
  override:
    # dependencies for testing with matryoshka
    - sudo pip install docker-py pyyaml flake8

test:
  override:
    # lint the python used for testing (node linting is done by the docker file)
    - flake8 $(git ls-files '*.py')
    # functional tests
    - bash ./tests/matryoshka-balance.sh ${docker_image} :
        parallel: true

